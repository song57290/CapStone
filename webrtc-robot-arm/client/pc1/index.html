<!doctype html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>PC1 - 실제 조이스틱 데이터 전송 및 영상 수신</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-gray-100">

<!-- 상단바 -->
<header class="flex items-center justify-between p-4 bg-blue-800 text-white">
  <div class="flex items-center gap-4">
    <img src="https://blog.kakaocdn.net/dn/71hSN/btsJTBBLxY4/JjQxPDPxp1BZhDPm9u0bEK/img.gif" alt="로고 이미지" class="h-14 w-auto rounded-4xl">
    <h1 class="text-xl font-bold whitespace-nowrap">PC1 - 실제 조이스틱 데이터 전송 및 영상 수신</h1>
  </div>
  <div class="flex gap-2">
    <button id="reconnectButton" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded">재연결</button>
    <button id="disconnectButton" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded">연결 종료</button>
  </div>
</header>

<main class="flex flex-col gap-4 p-4">
  <!-- 상태 및 조이스틱 데이터 -->
  <section class="flex flex-col gap-2 rounded bg-white p-4 shadow">
    <div id="status" class="text-lg font-semibold text-yellow-600">연결 대기중...</div>
    <div id="outgoingData" class="text-gray-700 text-center">전송 데이터 없음</div>
  </section>

  <!-- 중간: 비디오 화면 -->
  <section class="flex flex-col gap-4">
    <video id="remoteVideo" autoplay playsinline muted class="h-auto w-full rounded bg-black shadow"></video>

    <!-- 아래쪽: 사이즈 조절 박스 -->
    <div class="flex flex-wrap items-center gap-2 rounded bg-white p-2 shadow">
      <label for="videoWidth" class="text-sm">Width:</label>
      <input type="number" id="videoWidth" value="1920" class="w-24 rounded border p-1 text-sm" />
      <label for="videoHeight" class="text-sm">Height:</label>
      <input type="number" id="videoHeight" value="1080" class="w-24 rounded border p-1 text-sm" />
      <button id="updateSize" class="rounded bg-blue-600 px-2 py-1 text-sm text-white hover:bg-blue-700">사이즈 적용</button>
      <div class="ml-auto flex gap-4">
        <button id="playButton" class="bg-gray-500 hover:bg-gray-400 text-white px-4 py-2 rounded-4xl">재생 시작</button>
        <button id="pauseButton" class="bg-gray-500 hover:bg-gray-400 text-white px-4 py-2 rounded-4xl">재생 중단</button>
      </div>
    </div>
  </section>
</main>

<script src="https://cdn.jsdelivr.net/npm/simple-peer@9.11.0/simplepeer.min.js"></script>
<script src="https://cdn.socket.io/4.5.1/socket.io.min.js"></script>

<script>
  const signalingServer = 'https://my-signaling-server-uo91.onrender.com';
  const socket = io(signalingServer, { transports: ['websocket'] });
  let peer = null;

  // 시그널링 처리
  socket.on('signal', data => {
    console.log("PC1: Received signal:", data);
    if (peer) {
      try {
        peer.signal(data);
      } catch (e) {
        console.error("PC1: Error processing signal:", e);
      }
    }
  });

  // Peer 초기화
  function initializePeer() {
    if (peer && !peer.destroyed) {
      peer.destroy();
    }
    peer = new SimplePeer({
      initiator: true,
      trickle: false,
      config: { iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] }
    });

    peer.on('signal', data => {
      console.log("PC1: Peer signal generated:", data);
      socket.emit('signal', data);
    });

    peer.on('connect', () => {
      document.getElementById('status').innerText = 'PC2와 연결됨';
      console.log("PC1: Peer 연결 성공");
    });

    peer.on('close', () => {
      document.getElementById('status').innerText = '연결 끊어짐';
      console.log("PC1: Peer 연결 종료됨");
    });

    peer.on('track', (track, stream) => {
      console.log("PC1: Received track:", track.kind);
      const remoteVideo = document.getElementById('remoteVideo');
      remoteVideo.srcObject = stream;
    });
  }

  initializePeer();

  // 🎮 Gamepad로 조이스틱 데이터 송신
  function updateGamepad() {
    const gamepads = navigator.getGamepads ? navigator.getGamepads() : [];
    if (gamepads[0]) {
      const gp = gamepads[0];
      const data = {
        axes: gp.axes.map(v => +v.toFixed(2)),
        buttons: gp.buttons.map(b => b.pressed ? 1 : 0)
      };
      const displayText = `X: ${data.axes[0]}, Y: ${data.axes[1]}, Z: ${data.axes[3] || 0}, LB: ${data.buttons[4] || 0}, RB: ${data.buttons[5] || 0}`;
      document.getElementById('outgoingData').innerText = displayText;
      if (peer && peer.connected) {
        peer.send(JSON.stringify(data));
      }
    }
    requestAnimationFrame(updateGamepad);
  }

  window.addEventListener("gamepadconnected", () => {
    console.log("PC1: Gamepad connected");
    updateGamepad();
  });

  window.addEventListener("gamepaddisconnected", () => {
    console.log("PC1: Gamepad disconnected");
  });

  // 영상 컨트롤
  document.getElementById('playButton').addEventListener('click', () => {
    document.getElementById('remoteVideo').play().catch(err => console.error("PC1: Video play error:", err));
  });

  document.getElementById('pauseButton').addEventListener('click', () => {
    document.getElementById('remoteVideo').pause();
    console.log("PC1: Video paused");
  });

  document.getElementById('updateSize').addEventListener('click', () => {
    const width = document.getElementById('videoWidth').value;
    const height = document.getElementById('videoHeight').value;
    const remoteVideo = document.getElementById('remoteVideo');
    remoteVideo.style.width = width + 'px';
    remoteVideo.style.height = height + 'px';
    console.log(`PC1: Video size updated to ${width}x${height}`);
  });

  document.getElementById('disconnectButton').addEventListener('click', () => {
    socket.emit('disconnectSignal', { from: 'PC1' });
    if (peer && !peer.destroyed) {
      peer.destroy();
    }
    document.getElementById('status').innerText = '연결 끊어짐';
  });

  document.getElementById('reconnectButton').addEventListener('click', () => {
    initializePeer();
    document.getElementById('status').innerText = '연결 대기중...';
    socket.emit('reconnectRequest', { from: 'PC1' });
  });
</script>

</body>
</html>
