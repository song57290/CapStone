<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>PC2 - 조이스틱 데이터 수신 및 영상 송출</title>
  <style>
    #status { font-weight: bold; margin-bottom: 10px; }
    #joystickData { margin-bottom: 10px; }
    video { width: 640px; height: 480px; background: black; }
  </style>
</head>
<body>
  <h1>PC2: 조이스틱 데이터 수신 및 영상 송출</h1>
  <div id="status">연결 대기중...</div>
  <div id="joystickData">수신 데이터 없음</div>
  <video id="localVideo" autoplay playsinline muted></video>
  
  <!-- simple-peer와 socket.io 라이브러리 -->
  <script src="https://unpkg.com/simple-peer/simplepeer.min.js"></script>
  <script src="https://cdn.socket.io/4.5.1/socket.io.min.js"></script>
  <script>
    // 시그널링 서버 주소 (실제 주소와 포트로 수정)
    const signalingServer = 'http://192.168.35.25:3002';
    const socket = io(signalingServer);

    // non-initiator 역할로 peer 생성
    const peer = new SimplePeer({ initiator: false, trickle: false });

    peer.on('signal', data => {
      socket.emit('signal', data);
    });

    socket.on('signal', data => {
      peer.signal(data);
    });

    peer.on('connect', () => {
      document.getElementById('status').innerText = 'PC1과 연결됨';
    });

    // 데이터 채널을 통해 조이스틱 데이터를 수신
    peer.on('data', data => {
      try {
        const joystickData = JSON.parse(data.toString());
        document.getElementById('joystickData').innerText =
          `X: ${joystickData.x}, Y: ${joystickData.y}, Z: ${joystickData.z}, LB: ${joystickData.lb}, RB: ${joystickData.rb}`;
        // 실제로 ROS로 데이터를 전달하거나 Gazebo 제어 로직을 추가 가능
      } catch (err) {
        console.error('데이터 파싱 오류:', err);
      }
    });

    navigator.mediaDevices.getDisplayMedia({ video: true, audio: false })
  .then(stream => {
    const videoElem = document.getElementById('localVideo');
    videoElem.srcObject = stream;
    videoElem.play();
    peer.addStream(stream);
  })
  .catch(err => {
    console.error('화면 캡처 오류:', err);
  });
  </script>
</body>
</html>
